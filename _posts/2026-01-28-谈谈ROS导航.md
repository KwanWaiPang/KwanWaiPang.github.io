---
layout: post
title: "谈谈ROS的Navigation"
date:   2026-01-28
tags: [Robotics]
comments: true
author: kwanwaipang
toc: true
excerpt: "" # 【指定摘要内容】
---


<!-- * 目录
{:toc} -->


# 引言

# ROS1 导航架构概述

ROS1 Navigation依赖move_base 管理全局/局部规划/costmap以及恢复行为，通过硬编码状态机的方式实现，节点在（PLANNING，CONTROLLING， CLEARING ）几个状态进行切换。

* 下图为ROS1 Navigation Stack的核心架构：

<div class="mermaid" style="height: 400px; display: flex; justify-content: center; width: 100%; margin: 0 auto;">
graph TD
    %% 定义全局样式类
    classDef default fill:#fff,stroke:#333,stroke-width:1px,color:#000,rx:2,ry:2;

    %% --- 状态机描述（横向排列） ---
    subgraph SM [move_base 状态机]
        direction LR
        PLANNING[PLANNING] --> CONTROLLING[CONTROLLING] --> CLEARING[CLEARING]
    end

    %% --- 其他依赖 ---
    nav_core[nav_core<br/> 核心接口定义,元包]
    nav_core --> base_global_planner[nav_core::BaseGlobalPlanner<br/>全局规划器接口]
    base_global_planner --> base_local_planner[nav_core::BaseLocalPlanner<br/>局部规划器接口]
    base_local_planner --> recovery_behavior[nav_core::RecoveryBehavior<br/>恢复行为接口]

    %% --- Main Node ---
    %% 将状态机子图逻辑上置于 move_base 之上
    %% SM --- move_base
    %% 使用不可见连线强制 SM 在 move_base 上方
    SM ~~~ move_base


    subgraph SLAM [定位建图模块]
        direction TB
        Localization[Localization<br/>定位] --> Mapping[Mapping<br/>建图] --> map_server[map_server<br/>地图保存与发布]
    end

    Mapping-->StaticMap

    move_base[move_base<br/>导航栈的“大脑”，主状态机循环以及各个模块调用]

    %% --- Costmap Section ---
    move_base --> Costmap2D[Costmap 2D<br/>全局/局部代价地图 <br/> 将各种数据源（地图、传感器）融合成一张供规划器使用的代价地图]
    SensorData[传感器数据] --> Costmap2D
    StaticMap[静态地图] --> Costmap2D
    
    Costmap2D --> StaticLayer[静态层<br/>加载静态地图]
    Costmap2D --> ObstacleLayer[障碍物层<br/>接收激光、点云等传感器数据，标记实时障碍物]
    Costmap2D --> InflationLayer[膨胀层<br/> 根据障碍物生成膨胀区域，使机器人远离障碍物]

    %% --- Global Planner Section ---
    move_base --> GlobalPlannerMain[Global Planner<br/>全局规划器]
    GlobalPlannerMain --> Navfn[Navfn <br/>另一实现，同样支持 A* 和 Dijkstra]
    GlobalPlannerMain --> GlobalPlannerSub[Global Planner <br/>支持 A* 和 Dijkstra ]
    GlobalPlannerMain --> GlobalPath[全局路径]

    %% --- Local Planner Section ---
    GlobalPath --> LocalPlannerMain[Local Planner<br/>局部规划器]
    move_base --> LocalPlannerMain
    
    LocalPlannerMain --> TebLocalPlanner[Teb Local Planner <br/> 基于时间弹性带算法]
    LocalPlannerMain --> DWA[DWA <br/> 动态窗口法]
    LocalPlannerMain --> BaseLocalPlanner[Base Local Planner]
    LocalPlannerMain --> VelocityCommand[速度指令]

    %% --- Recovery Behaviors Section ---
    move_base --> RecoveryBehaviors[Recovery Behaviors<br/>恢复行为]
    RecoveryBehaviors --> ClearCostmap[清除代价地图]
    RecoveryBehaviors --> RotateRecovery[旋转360度恢复/移动恢复]
</div>

* 若链接CostMap与规划器，则更加复杂：

<div class="mermaid" style="height: 400px; display: flex; justify-content: center; width: 100%; margin: 0 auto;">
%%{init: {'flowchart': {'defaultRenderer': 'elk'}}}%%
flowchart TB
 subgraph SM["move_base 状态机"]
    direction LR
        CLEARING["CLEARING"]
        CONTROLLING["CONTROLLING"]
        PLANNING["PLANNING"]
  end
 subgraph SLAM["定位建图模块"]
    direction TB
        map_server["map_server<br/>地图保存与发布"]
        Mapping["Mapping<br/>建图"]
        Localization["Localization<br/>定位"]
  end
    PLANNING --> CONTROLLING
    CONTROLLING --> CLEARING
    nav_core["nav_core<br/> 核心接口定义,元包"] --> base_global_planner["nav_core::BaseGlobalPlanner<br/>全局规划器接口"]
    base_global_planner --> base_local_planner["nav_core::BaseLocalPlanner<br/>局部规划器接口"]
    base_local_planner --> recovery_behavior["nav_core::RecoveryBehavior<br/>恢复行为接口"]
    SM ~~~ move_base["move_base<br/>导航栈的“大脑”，主状态机循环以及各个模块调用"]
    Localization --> Mapping
    Mapping --> map_server & StaticMap["静态地图"]
    move_base --> Costmap2D["Costmap 2D<br/>全局/局部代价地图 <br/> 将各种数据源（地图、传感器）融合成一张供规划器使用的代价地图"] & GlobalPlannerMain["Global Planner<br/>全局规划器"] & LocalPlannerMain["Local Planner<br/>局部规划器"] & RecoveryBehaviors["Recovery Behaviors<br/>恢复行为"]
    SensorData["传感器数据"] --> Costmap2D
    StaticMap --> Costmap2D
    Costmap2D --> StaticLayer["静态层<br/>加载静态地图"] & ObstacleLayer["障碍物层<br/>接收激光、点云等传感器数据，标记实时障碍物"] & InflationLayer["膨胀层<br/> 根据障碍物生成膨胀区域，使机器人远离障碍物"] & GlobalPlannerMain & LocalPlannerMain
    GlobalPlannerMain --> Navfn["Navfn <br/>另一实现，同样支持 A* 和 Dijkstra"] & GlobalPlannerSub["Global Planner <br/>支持 A* 和 Dijkstra"] & GlobalPath["全局路径"]
    GlobalPath --> LocalPlannerMain
    LocalPlannerMain --> TebLocalPlanner["Teb Local Planner <br/> 基于时间弹性带算法"] & DWA["DWA <br/> 动态窗口法"] & BaseLocalPlanner["Base Local Planner"] & VelocityCommand["速度指令"]
    RecoveryBehaviors --> ClearCostmap["清除代价地图"] & RotateRecovery["旋转360度恢复/移动恢复"]

    classDef default fill:#fff,stroke:#333,stroke-width:1px,color:#000,rx:2,ry:2
</div>

# ROS2 导航架构概述

ROS2 Nav2 将 ROS1 单体的 `move_base` 拆分为多个独立 Server（模块化解耦）每个 Server 专注单一功能，通过标准化接口协作，配合行为树（BT） 完成导航。

Nav2 的核心思想是 “服务器（Server）+ 行为树（Behavior Tree）+ 生命周期管理（Lifecycle Manager）”。它不再是一个像 `move_base` 那样的单体大节点，而是由多个独立的、可管理的节点组成。

* 下图为ROS2核心架构与工作流程：

<div class="mermaid" style="height: 400px; display: flex; justify-content: center; width: 100%; margin: 0 auto;">
---
config:
  layout: elk
---
flowchart LR
%%  subgraph Nav2System ["Nav2 系统：服务器集群"]
    direction TB
        MapServer["Map Server<br>地图服务器"]
        AMCL["AMCL<br>定位节点"]
        PlannerServer["Planner Server<br>规划服务器"]
        ControllerServer["Controller Server<br>控制服务器"]
        BTNavigator["Behavior Tree Navigator<br>行为树导航器"]
%%   end
 subgraph Plugins["单个服务器内部：插件化"]
    direction LR
        P_NavFn["插件1<br>NavFn"]
        P_Smac["插件2<br>Smac Planner"]
        C_DWB["插件1<br>DWB"]
        C_TEB["插件2<br>TEB"]
  end
    LifecycleManager["Lifecycle Manager<br>周期管理器"] --> ManageNode(("管理"))
    ManageNode -- 加载 --> MapServer
    ManageNode --> AMCL & PlannerServer & ControllerServer & BTNavigator
    StaticMapData["静态地图"] -- 加载 --> MapServer
    MapServer -- 静态地图数据 --> AMCL & PlannerServer & ControllerServer
    SensorData["传感器数据"] -- 激光/点云 --> AMCL & PlannerServer & ControllerServer
    AMCL -- 机器人位姿 --> PlannerServer & BTNavigator & ControllerServer
    UserApp["用户/应用"] -- 导航目标<br>机器人位姿 --> BTNavigator
    BTNavigator -- 计算路径任务 --> PlannerServer
    PlannerServer -- 全局路径 --> BTNavigator
    BTNavigator -- 路径跟踪任务 --> ControllerServer
    BTNavigator -- 全局路径 --> ControllerServer
    PlannerServer -.- P_NavFn & P_Smac
    ControllerServer -.- C_DWB & C_TEB
    ControllerServer --> CmdVel["速度指令<br>cmd_vel"]
    CmdVel --> RobotBase["机器人底座"]

    classDef default fill:#fff,stroke:#333,stroke-width:1px,color:#000,rx:2,ry:2
    classDef highlight fill:#fdfbe8,stroke:#d4c359,stroke-width:2px
</div>

# 参考资料
* [ROS 1的Navigation 和 ROS 2的Navigation2（Nav2）](https://blog.csdn.net/weixin_41469272/article/details/152025707)
